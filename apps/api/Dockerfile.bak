# Stage: builder
FROM node:20-alpine AS builder
WORKDIR /workspace/apps/api

# Copy only package manifests first for better caching
COPY package.json package-lock.json ./
COPY apps/api/package.json apps/api/package-lock.json ./apps/api/

# Move into the api folder and install production deps for runtime
WORKDIR /workspace/apps/api
# Install production dependencies only (faster, smaller)
RUN npm ci --production

# Copy source files
COPY apps/api/ ./ 

# Stage: runtime
FROM node:20-alpine AS runtime
WORKDIR /app

# Copy production node_modules from builder
COPY --from=builder /workspace/apps/api/node_modules ./node_modules

# Copy app source
COPY --from=builder /workspace/apps/api/ ./

# Use a non-root user for better security
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser

ENV NODE_ENV=production
EXPOSE 3001

# Start the server
CMD ["node", "src/server.js"]
